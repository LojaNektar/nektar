<!DOCTYPE html>
<html lang="pt-BR">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Cat√°logo de Perfumes</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="css/index.css">
	
	<style>
		.carrinho-flutuante {
			position: fixed;
			bottom: 20px;
			right: 20px;
			background-color: #25D366; /* Cor do WhatsApp */
			color: white;
			border: none;
			border-radius: 50px;
			padding: 15px 25px;
			font-size: 1.1em;
			font-weight: bold;
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
			cursor: pointer;
			z-index: 1000;
			display: flex;
			align-items: center;
			gap: 8px;
			transition: background-color 0.3s;
		}

		.carrinho-flutuante:hover {
			background-color: #128C7E;
		}

		#contadorCarrinho {
			background-color: #ffc107;
			color: #333;
			border-radius: 50%;
			padding: 4px 8px;
			font-size: 0.9em;
			line-height: 1;
		}
		
		/* Ajuste para o bot√£o no card */
		.btn-add-carrinho {
		    background-color: #198754; /* Verde do Success */
		    color: white;
		    border: none;
		    transition: background-color 0.3s;
			margin-top: 10px; 
		}
		
		.btn-add-carrinho:hover {
		    background-color: #157347;
		    color: white;
		}
		
		/* Garante que o card-body tenha padding na parte inferior */
		.card-body {
			padding-bottom: 15px !important;
		}

		/* Remove o onclick do card para evitar conflito com o bot√£o de adicionar */
		.card[onclick] {
			cursor: default !important;
		}
		
		/* Estilo para o modal de carrinho */
		#modalCarrinho .modal-footer {
			border-top: none;
			padding-top: 0;
		}
		#modalCarrinho .modal-body {
			padding-bottom: 0;
		}
	</style>
</head>

<body>
	<div class="container py-4">
		<h1 class="text-center mb-4">Cat√°logo de Perfumes</h1>

		<div class="row mb-4">
			<nav class="col-12 d-flex gap-2 flex-wrap justify-content-center" aria-label="Menu principal">
				<a href="index.html" class="btn-grad btn btn-outline-primary">In√≠cio</a>
				<a href="perfumes.html" class="btn-grad btn btn-outline-primary">Importados</a>
				<a href="arabes.html" class="btn-grad btn btn-outline-primary">√Årabes</a>
				<a href="tenis.html" class="btn-grad btn btn-outline-primary">T√™nis</a>
			</nav>
		</div>

		<div class="row mb-4">
			<div class="col-md-6 mx-auto">
				<input type="text" id="search" class="form-control" placeholder="üîç Buscar perfume ou marca...">
			</div>
		</div>

		<div class="categorias-header">
			<h5>Filtrar por Marca</h5>
			<div class="categorias-lista" id="marcasTabs"></div>
		</div>

		<div id="catalogoContainer"></div>
	</div>

	<div class="modal fade" id="modalOpcoes" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Outras op√ß√µes dispon√≠veis</h5>
					<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					Consulte varia√ß√µes como <strong>30ml, 50ml, 100ml</strong> (pode variar conforme disponibilidade).
					<br><br>
					<em>Fale com a gente para confirmar!</em>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" data-bs-dismiss="modal">Ok</button>
				</div>
			</div>
		</div>
	</div>
	<button id="abrirCarrinho" class="carrinho-flutuante" onclick="abrirModalCarrinho()">
	    üõí Meu Pedido (<span id="contadorCarrinho">0</span>)
	</button>
	<div class="modal fade" id="modalCarrinho" tabindex="-1" aria-labelledby="modalCarrinhoLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="modalCarrinhoLabel">üõí Seu Pedido</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div id="itensCarrinhoLista">
						</div>
				</div>
				<div class="modal-footer d-flex flex-column align-items-stretch">
					<p class="h4 text-end mb-3" id="carrinhoTotal">Total Estimado: R$ 0,00</p>
					<button type="button" class="btn btn-success btn-lg w-100" onclick="finalizarPedidoWhatsApp()">
						‚úÖ Finalizar Pedido no WhatsApp
					</button>
					<button type="button" class="btn btn-outline-secondary mt-2" data-bs-dismiss="modal">
						Continuar Comprando
					</button>
				</div>
			</div>
		</div>
	</div>
	<script>
		let perfumes = [];
		const generos = { "MASC": "Masculino", "FEM": "Feminino", "UNI": "Unissex" };
		const NUMERO_WHATSAPP = "5537998195214";
		let carrinho = []; // Vari√°vel global para armazenar o carrinho
		
		// --- Fun√ß√µes de Carrinho (NOVAS) ---
		function carregarCarrinho() {
			try {
				carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
			} catch (e) {
				console.error("Erro ao carregar carrinho do localStorage:", e);
				carrinho = [];
			}
			atualizarContadorCarrinho();
		}
		
		function salvarCarrinho() {
		    localStorage.setItem('carrinho', JSON.stringify(carrinho));
		    atualizarContadorCarrinho();
		}

		function atualizarContadorCarrinho() {
			const contador = document.getElementById('contadorCarrinho');
			if (contador) {
				contador.innerText = carrinho.length;
			}
		}

		function adicionarAoCarrinho(nome, marca, venda, tipo = 'Perfume Importado') {
			const item = {
				nome: nome,
				marca: marca,
				preco: venda,
				tipo: tipo,
				id: Date.now() 
			};
			carrinho.push(item);
			salvarCarrinho();
			alert(`${nome} (${marca}) foi adicionado ao seu pedido!`);
		}
		
		function removerDoCarrinho(id) {
			// Filtra o carrinho, mantendo apenas os itens que N√ÉO possuem o ID fornecido
		    carrinho = carrinho.filter(item => item.id !== id);
		    salvarCarrinho();
			// Re-renderiza o modal para mostrar a lista atualizada
			abrirModalCarrinho(true); 
		}
		
		// Converte string de pre√ßo (R$ 1.000,00) para n√∫mero (1000.00)
		function stringParaFloat(precoStr) {
			if (!precoStr) return 0;
			return parseFloat(precoStr.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0;
		}

		// Abre o Modal, preenchendo a lista de itens
		function abrirModalCarrinho(reabrir = false) {
			if (carrinho.length === 0) {
				alert("Seu pedido est√° vazio. Adicione um ou mais produtos!");
				return;
			}
			
			const listaContainer = document.getElementById('itensCarrinhoLista');
			let html = `<ul class="list-group list-group-flush">`;
			let totalEstimado = 0;

			carrinho.forEach(item => {
				const valorItem = stringParaFloat(item.preco);
				totalEstimado += valorItem;

				html += `
					<li class="list-group-item d-flex justify-content-between align-items-center">
						<div>
							<strong>${item.tipo}:</strong> ${item.nome} (${item.marca})<br>
							<small class="text-muted">${item.preco}</small>
						</div>
						<button class="btn btn-sm btn-danger" onclick="removerDoCarrinho(${item.id})">
							Remover
						</button>
					</li>
				`;
			});

			html += `</ul>`;
			listaContainer.innerHTML = html;

			const totalFormatado = totalEstimado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
			document.getElementById('carrinhoTotal').innerHTML = `Total Estimado: ${totalFormatado}`;
			
			if (!reabrir) {
				const modal = new bootstrap.Modal(document.getElementById("modalCarrinho"));
				modal.show();
			}
		}

		function finalizarPedidoWhatsApp() {
		    if (carrinho.length === 0) {
		        alert("O carrinho est√° vazio. Adicione itens antes de finalizar.");
		        return;
		    }
		
		    let mensagem = "Ol√°! Gostaria de finalizar a compra dos seguintes itens:\n\n";
		    let totalEstimado = 0;
		
		    carrinho.forEach((item, index) => {
		        const valorItem = stringParaFloat(item.preco);
		        totalEstimado += valorItem;
		
		        mensagem += `${index + 1}. [${item.tipo}] ${item.nome} (${item.marca}) - ${item.preco}\n`;
		    });
		
		    const totalFormatado = totalEstimado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
		    
		    mensagem += `\nTotal Estimado: ${totalFormatado}`;
		    mensagem += `\n*Os valores s√£o estimados. Favor confirmar disponibilidade e pre√ßo final.`;
		
		    const linkWhatsApp = `https://wa.me/${NUMERO_WHATSAPP}?text=${encodeURIComponent(mensagem)}`;
		
			// Fecha o modal antes de abrir o WhatsApp
			const modalEl = document.getElementById('modalCarrinho');
			const modal = bootstrap.Modal.getInstance(modalEl);
			if (modal) modal.hide();
			
		    window.open(linkWhatsApp, '_blank');
		}

		
		// --- Fun√ß√µes de Renderiza√ß√£o e Cat√°logo (Adaptadas) ---

		// Monta a lista de marcas (bot√µes e se√ß√µes)
		function renderizarMarcas(lista) {
			const marcas = [...new Set(lista.map(p => p.Marca))].sort();
			const tabs = document.getElementById("marcasTabs");
			const container = document.getElementById("catalogoContainer");

			tabs.innerHTML = "";
			container.innerHTML = "";

			marcas.forEach(marca => {
				const marcaId = marca.toLowerCase().replace(/[^a-z0-9]+/g, "-");

				tabs.innerHTML += `
					<button onclick="scrollToSection('${marcaId}')">${marca}</button>
				`;

				const perfumesDaMarca = lista.filter(p => p.Marca === marca);
				container.innerHTML += gerarHTMLMarca(marca, perfumesDaMarca);
			});
		}

		// Gera HTML de cada marca (com section)
		function gerarHTMLMarca(marca, itens) {
			const agrupados = Object.keys(generos).map(gen => ({
				genero: generos[gen],
				itens: itens.filter(p => (p.Genero || "").toUpperCase() === gen)
			})).filter(g => g.itens.length > 0);

			return `
				<section id="${marca.toLowerCase().replace(/[^a-z0-9]+/g, "-")}" class="mb-5">
					<h3 class="text-gradient mb-3">${marca}</h3>
					${agrupados.map(g => `
						<div class="categoria mb-4">
							<h4 class="mb-3">${g.genero}</h4>
							<div class="row g-3">
								${g.itens.map(p => `
									<div class="col-6 col-md-4 col-lg-3">
										<div class="card h-100" onclick="abrirOpcoes('${p.Perfume}')">
											<img src="${p.Imagem}" alt="${p.Perfume}">
											<div class="card-body">
												<h5>${p.Perfume}</h5>
												<p><strong>Marca:</strong> ${p.Marca}</p>
												<p>${p.Tipo} ${p.ml} a partir de <strong>${p.Venda}</strong></p>
												<p>* Valor sujeito a altera√ß√£o conforme disponibilidade</p>
												
												<button onclick="event.stopPropagation(); adicionarAoCarrinho('${p.Perfume}', '${p.Marca}', '${p.Venda}', 'Perfume Importado')" 
													class="btn btn-sm btn-add-carrinho w-100">
													üõçÔ∏è Adicionar ao Pedido
												</button>
											</div>
										</div>
									</div>
								`).join("")}
							</div>
						</div>
					`).join("")}
				</section>
			`;
		}

		function scrollToSection(id) {
			const section = document.getElementById(id);
			if (section) section.scrollIntoView({ behavior: "smooth", block: "start" });
		}

		function abrirOpcoes(nomePerfume) {
			const modal = new bootstrap.Modal(document.getElementById("modalOpcoes"));
			document.querySelector("#modalOpcoes .modal-title").innerText = nomePerfume + " ‚Äì outras op√ß√µes";
			modal.show();
		}

		async function carregarDados() {
			carregarCarrinho(); // Carrega o carrinho antes de tudo
			try {
				const response = await fetch("catalogo/perfumes.json");
				if (!response.ok) throw new Error("Falha no fetch do JSON");
				perfumes = await response.json();
				renderizarMarcas(perfumes);
				setTimeout(() => {
			¬† ¬† ¬† const hash = window.location.hash.replace("#", "");
			¬† ¬† ¬† if (hash) {
			¬† ¬† ¬† ¬† const target = document.getElementById(hash);
			¬† ¬† ¬† ¬† if (target) {
			¬† ¬† ¬† ¬† ¬† target.scrollIntoView({ behavior: "smooth", block: "start" });
			¬† ¬† ¬† ¬† }
			¬† ¬† ¬† }
			¬† ¬† }, 400); // aguarda o DOM renderizar
			} catch (error) {
				console.error("Erro ao carregar JSON:", error);
			}
		}

		document.getElementById("search").addEventListener("input", e => {
			const termo = e.target.value.toLowerCase();
			const filtrados = perfumes.filter(p =>
				p.Perfume.toLowerCase().includes(termo) ||
				p.Marca.toLowerCase().includes(termo)
			);
			renderizarMarcas(filtrados);
		});

		carregarDados();
	</script>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

	<footer>
		¬© 2025 Nektar. Todos os direitos reservados.<br>
		<small>Feito com üíô e estilo.</small>
	</footer>
</body>

</html>
